import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { 
  ArrowLeft, Lightbulb, Search, Loader2, Plus, Check, 
  TrendingUp, Users, MapPin, Sparkles, RefreshCw
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import { cn } from '@/lib/utils';

export default function KeywordResearch() {
  const params = new URLSearchParams(window.location.search);
  const projectId = params.get('project_id');
  const queryClient = useQueryClient();
  
  const [seedKeyword, setSeedKeyword] = useState('');
  const [isResearching, setIsResearching] = useState(false);

  const { data: project } = useQuery({
    queryKey: ['project', projectId],
    queryFn: () => base44.entities.Project.filter({ id: projectId }),
    select: (data) => data[0],
    enabled: !!projectId
  });

  const { data: suggestions = [], isLoading: loadingSuggestions } = useQuery({
    queryKey: ['keyword-suggestions', projectId],
    queryFn: () => base44.entities.KeywordSuggestion.filter({ project_id: projectId }, '-relevance_score', 50),
    enabled: !!projectId
  });

  const researchKeywords = async () => {
    if (!seedKeyword.trim() || !project) return;
    setIsResearching(true);

    const prompt = `Generate 10 local SEO keyword suggestions for a business called "${project.business_name}" based on the seed keyword "${seedKeyword}".
    
    The business is located at: ${project.business_address || 'local area'}
    
    For each keyword, provide:
    - The suggested keyword (focus on local intent keywords like "near me", "in [city]", service-specific terms)
    - Search volume estimate (high/medium/low)
    - Competition level (high/medium/low)
    - Relevance score (1-100)
    - Whether it has local intent (true/false)
    
    Focus on keywords that would appear in Google Maps / Local Pack results.`;

    const result = await base44.integrations.Core.InvokeLLM({
      prompt,
      response_json_schema: {
        type: 'object',
        properties: {
          keywords: {
            type: 'array',
            items: {
              type: 'object',
              properties: {
                keyword: { type: 'string' },
                search_volume: { type: 'string', enum: ['high', 'medium', 'low'] },
                competition: { type: 'string', enum: ['high', 'medium', 'low'] },
                relevance_score: { type: 'number' },
                is_local_intent: { type: 'boolean' }
              }
            }
          }
        }
      }
    });

    // Save suggestions
    const newSuggestions = result.keywords.map(kw => ({
      project_id: projectId,
      seed_keyword: seedKeyword,
      suggested_keyword: kw.keyword,
      search_volume: kw.search_volume,
      competition: kw.competition,
      relevance_score: kw.relevance_score,
      is_local_intent: kw.is_local_intent,
      added_to_tracking: false
    }));

    await base44.entities.KeywordSuggestion.bulkCreate(newSuggestions);
    queryClient.invalidateQueries(['keyword-suggestions', projectId]);
    setSeedKeyword('');
    setIsResearching(false);
  };

  const addToTracking = useMutation({
    mutationFn: async (suggestion) => {
      // Add keyword to project
      const updatedKeywords = [...(project.keywords || []), suggestion.suggested_keyword];
      await base44.entities.Project.update(projectId, { keywords: updatedKeywords });
      
      // Mark suggestion as added
      await base44.entities.KeywordSuggestion.update(suggestion.id, { added_to_tracking: true });
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['project', projectId]);
      queryClient.invalidateQueries(['keyword-suggestions', projectId]);
    }
  });

  const getVolumeColor = (vol) => {
    if (vol === 'high') return 'bg-emerald-100 text-emerald-700 border-emerald-200';
    if (vol === 'medium') return 'bg-amber-100 text-amber-700 border-amber-200';
    return 'bg-slate-100 text-slate-600 border-slate-200';
  };

  const getCompetitionColor = (comp) => {
    if (comp === 'high') return 'bg-red-100 text-red-700 border-red-200';
    if (comp === 'medium') return 'bg-orange-100 text-orange-700 border-orange-200';
    return 'bg-green-100 text-green-700 border-green-200';
  };

  if (!projectId) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
        <div className="text-center">
          <p className="text-slate-500 mb-4">No project selected</p>
          <Link to={createPageUrl('Dashboard')}>
            <Button>Back to Dashboard</Button>
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 pb-24">
      {/* Header */}
      <div className="bg-white border-b border-slate-100 px-4 py-4">
        <div className="max-w-lg mx-auto flex items-center gap-3">
          <Link to={createPageUrl(`ProjectDetail?id=${projectId}`)}>
            <Button variant="ghost" size="icon" className="h-9 w-9">
              <ArrowLeft className="h-5 w-5" />
            </Button>
          </Link>
          <div>
            <h1 className="text-lg font-semibold text-slate-900">Keyword Research</h1>
            <p className="text-xs text-slate-500">{project?.name}</p>
          </div>
        </div>
      </div>

      <div className="max-w-lg mx-auto px-4 py-6 space-y-5">
        {/* Current Keywords */}
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-base flex items-center gap-2">
              <Search className="h-4 w-4" />
              Currently Tracking ({project?.keywords?.length || 0})
            </CardTitle>
          </CardHeader>
          <CardContent>
            {project?.keywords?.length > 0 ? (
              <div className="flex flex-wrap gap-2">
                {project.keywords.map((kw, idx) => (
                  <Badge key={idx} variant="secondary" className="bg-blue-50 text-blue-700 border-blue-200">
                    {kw}
                  </Badge>
                ))}
              </div>
            ) : (
              <p className="text-sm text-slate-500">No keywords being tracked yet</p>
            )}
          </CardContent>
        </Card>

        {/* Research Tool */}
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-base flex items-center gap-2">
              <Sparkles className="h-4 w-4" />
              AI Keyword Research
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <p className="text-sm text-slate-600">
              Enter a seed keyword to discover related local SEO keywords for your business.
            </p>
            <div className="flex gap-2">
              <Input
                placeholder="e.g., plumber, dentist, pizza"
                value={seedKeyword}
                onChange={(e) => setSeedKeyword(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && researchKeywords()}
                className="flex-1"
              />
              <Button
                onClick={researchKeywords}
                disabled={!seedKeyword.trim() || isResearching}
                className="gap-1.5"
              >
                {isResearching ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  <Lightbulb className="h-4 w-4" />
                )}
                Research
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Suggestions */}
        <div>
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-semibold text-slate-900">
              Keyword Suggestions ({suggestions.length})
            </h3>
          </div>

          {loadingSuggestions ? (
            <div className="space-y-2">
              {[1, 2, 3].map(i => <Skeleton key={i} className="h-24 rounded-xl" />)}
            </div>
          ) : suggestions.length === 0 ? (
            <div className="bg-white rounded-xl border border-slate-100 p-6 text-center">
              <Lightbulb className="h-8 w-8 text-slate-300 mx-auto mb-2" />
              <p className="text-sm text-slate-500">
                No suggestions yet. Enter a seed keyword above to get started.
              </p>
            </div>
          ) : (
            <div className="space-y-2">
              {suggestions.map(suggestion => (
                <div
                  key={suggestion.id}
                  className={cn(
                    'bg-white rounded-xl border p-4 transition-all',
                    suggestion.added_to_tracking 
                      ? 'border-green-200 bg-green-50/50' 
                      : 'border-slate-100 hover:border-slate-200'
                  )}
                >
                  <div className="flex items-start justify-between gap-3">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className="font-medium text-slate-900">
                          {suggestion.suggested_keyword}
                        </span>
                        {suggestion.is_local_intent && (
                          <Badge variant="outline" className="text-xs bg-purple-50 text-purple-700 border-purple-200">
                            <MapPin className="h-3 w-3 mr-1" />
                            Local
                          </Badge>
                        )}
                      </div>
                      
                      <div className="flex items-center gap-2 mt-2">
                        <Badge variant="outline" className={cn('text-xs', getVolumeColor(suggestion.search_volume))}>
                          <TrendingUp className="h-3 w-3 mr-1" />
                          {suggestion.search_volume} volume
                        </Badge>
                        <Badge variant="outline" className={cn('text-xs', getCompetitionColor(suggestion.competition))}>
                          <Users className="h-3 w-3 mr-1" />
                          {suggestion.competition} comp.
                        </Badge>
                      </div>
                      
                      <div className="mt-2 flex items-center gap-2">
                        <div className="flex-1 bg-slate-100 rounded-full h-1.5">
                          <div 
                            className="bg-blue-500 h-1.5 rounded-full" 
                            style={{ width: `${suggestion.relevance_score}%` }}
                          />
                        </div>
                        <span className="text-xs text-slate-500">{suggestion.relevance_score}% match</span>
                      </div>
                    </div>

                    {suggestion.added_to_tracking ? (
                      <div className="p-2 bg-green-100 rounded-lg">
                        <Check className="h-4 w-4 text-green-600" />
                      </div>
                    ) : (
                      <Button
 
